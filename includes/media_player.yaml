


#  ##########################  Tablets  ##########################
  - platform: universal
    name: Universal Tablet Myriam S8
    unique_id: universal_tablet_myriam_s8
    children:     
      - media_player.jellyfin_tablet_myriam_alt
      - media_player.jellyfin_tablet_myriam
                     
    active_child_template:  >-
                  {% set alt_player = 'media_player.jellyfin_tablet_myriam_alt' %}
                  {% set main_player = 'media_player.jellyfin_tablet_myriam' %}
                   {% if is_state(main_player,'playing')  %}
                    {{ main_player }}
                  {% elif is_state(alt_player,'playing')  %}
                    {{ alt_player }}
                  {% elif not is_state(main_player,'idle')  %}
                    {{ main_player }}
                  {% elif not is_state(alt_player,'idle')  %}
                    {{ alt_player }}
                  {% else %}
                   {{ alt_player }}
                  {% endif %} 

  ##########################  Home Group  ##########################
  - platform: universal
    name: Universal Home Speakers
    unique_id: universal_home_speakers
    children:     
      - media_player.group_mass_home_group_speakers               
    active_child_template: media_player.group_mass_home_group_speakers
    
   ##########################  bedroom  ##########################
  - platform: universal
    name: Universal bedroom Speakers
    unique_id: universal_bedroom_speakers
    children:
      - media_player.mass_bedroom_airplay_wiim_speaker
      - media_player.wiim_bedroom_linkplay
      - media_player.group_mass_home_group_speakers
    active_child_template: >-
                  {% set mass_speaker = 'media_player.mass_bedroom_airplay_wiim_speaker' %}
                  {% set linkplay_speaker = 'media_player.wiim_bedroom_linkplay' %}
                  {% set mass_home_group = 'media_player.group_mass_home_group_speakers' %}
                  {% if states(linkplay_speaker) == 'idle' and states(mass_speaker) == 'idle' %}
                    {{ linkplay_speaker }}
                  {% else %}             
                    {{ mass_speaker }}
                  {% endif %}
    state_template: >-
                  {% set mass_speaker = 'media_player.mass_bedroom_airplay_wiim_speaker' %}
                  {% set linkplay_speaker = 'media_player.wiim_bedroom_linkplay' %}
                  {% set mass_home_group = 'media_player.group_mass_home_group_speakers' %}
                  {% if states(linkplay_speaker) == 'idle' and states(mass_speaker) == 'idle' %}
                  off
                  {% else %}             
                    {{ states(mass_speaker) }}
                  {% endif %}
    commands:
      volume_up:
        service: media_player.volume_up
        target:
          entity_id: 
            - media_player.wiim_bedroom_linkplay
      volume_down:
        service: media_player.volume_down
        target:
          entity_id: 
            - media_player.wiim_bedroom_linkplay
      volume_mute:
        service: media_player.volume_mute
        target:
          entity_id: 
            - media_player.wiim_bedroom_linkplay
        data:
          is_volume_muted: "{{ is_volume_muted }}"
      volume_set:
        service: media_player.volume_set
        target:
          entity_id: 
            - media_player.wiim_bedroom_linkplay
        data:
          volume_level: "{{ volume_level }}"
      turn_off:
        service: media_player.clear_playlist
        target:
          entity_id: 
            - media_player.mass_bedroom_airplay_wiim_speaker
      turn_on:
        service: media_player.media_play
        target:
          entity_id: 
            - media_player.mass_bedroom_airplay_wiim_speaker
    attributes:
      is_volume_muted: media_player.wiim_bedroom_linkplay|is_volume_muted
      volume_level: media_player.wiim_bedroom_linkplay|volume_level
      
 


  ##########################  workshop  ##########################
  - platform: universal
    name: Universal workshop Speakers
    unique_id: universal_workshop_speakers
    children:
      - media_player.mass_workshop_airplay_wiim_speaker
      - media_player.wiim_workshop_linkplay
      - media_player.group_mass_home_group_speakers
    active_child_template: >-
                  {% set mass_speaker = 'media_player.mass_workshop_airplay_wiim_speaker' %}
                  {% set linkplay_speaker = 'media_player.wiim_workshop_linkplay' %}
                  {% set mass_home_group = 'media_player.group_mass_home_group_speakers' %}
                  {% if states(linkplay_speaker) == 'idle' and states(mass_speaker) == 'idle' %}
                    {{ linkplay_speaker }}
                  {% else %}             
                    {{ mass_speaker }}
                  {% endif %}
    state_template: >-
                  {% set mass_speaker = 'media_player.mass_workshop_airplay_wiim_speaker' %}
                  {% set linkplay_speaker = 'media_player.wiim_workshop_linkplay' %}
                  {% set mass_home_group = 'media_player.group_mass_home_group_speakers' %}
                  {% if states(linkplay_speaker) == 'idle' and states(mass_speaker) == 'idle' %}
                  off
                  {% else %}             
                    {{ states(mass_speaker) }}
                  {% endif %}
    commands:
      volume_up:
        service: media_player.volume_up
        target:
          entity_id: 
            - media_player.wiim_workshop_linkplay
      volume_down:
        service: media_player.volume_down
        target:
          entity_id: 
            - media_player.wiim_workshop_linkplay
      volume_mute:
        service: media_player.volume_mute
        target:
          entity_id: 
            - media_player.wiim_workshop_linkplay
        data:
          is_volume_muted: "{{ is_volume_muted }}"
      volume_set:
        service: media_player.volume_set
        target:
          entity_id: 
            - media_player.wiim_workshop_linkplay
        data:
          volume_level: "{{ volume_level }}"
      turn_off:
        service: media_player.clear_playlist
        target:
          entity_id: 
            - media_player.mass_workshop_airplay_wiim_speaker
      turn_on:
        service: media_player.media_play
        target:
          entity_id: 
            - media_player.mass_workshop_airplay_wiim_speaker
    attributes:
      is_volume_muted: media_player.wiim_workshop_linkplay|is_volume_muted
      volume_level: media_player.wiim_workshop_linkplay|volume_level
      
 

   ##########################  kitchen  ##########################
  - platform: universal
    name: Universal kitchen Speakers
    unique_id: universal_kitchen_speakers
    children:
      - media_player.mass_kitchen_airplay_wiim_speaker
      - media_player.wiim_kitchen_linkplay
      - media_player.group_mass_home_group_speakers
    active_child_template: >-
                  {% set mass_speaker = 'media_player.mass_kitchen_airplay_wiim_speaker' %}
                  {% set linkplay_speaker = 'media_player.wiim_kitchen_linkplay' %}
                  {% set mass_home_group = 'media_player.group_mass_home_group_speakers' %}
                  {% if states(linkplay_speaker) == 'idle' and states(mass_speaker) == 'idle' %}
                    {{ linkplay_speaker }}
                  {% else %}             
                    {{ mass_speaker }}
                  {% endif %}
    state_template: >-
                  {% set mass_speaker = 'media_player.mass_kitchen_airplay_wiim_speaker' %}
                  {% set linkplay_speaker = 'media_player.wiim_kitchen_linkplay' %}
                  {% set mass_home_group = 'media_player.group_mass_home_group_speakers' %}
                  {% if states(linkplay_speaker) == 'idle' and states(mass_speaker) == 'idle' %}
                  off
                  {% else %}             
                    {{ states(mass_speaker) }}
                  {% endif %}
    commands:
      volume_up:
        service: media_player.volume_up
        target:
          entity_id: 
            - media_player.wiim_kitchen_linkplay
      volume_down:
        service: media_player.volume_down
        target:
          entity_id: 
            - media_player.wiim_kitchen_linkplay
      volume_mute:
        service: media_player.volume_mute
        target:
          entity_id: 
            - media_player.wiim_kitchen_linkplay
        data:
          is_volume_muted: "{{ is_volume_muted }}"
      volume_set:
        service: media_player.volume_set
        target:
          entity_id: 
            - media_player.wiim_kitchen_linkplay
        data:
          volume_level: "{{ volume_level }}"
      turn_off:
        service: media_player.clear_playlist
        target:
          entity_id: 
            - media_player.mass_kitchen_airplay_wiim_speaker
      turn_on:
        service: media_player.media_play
        target:
          entity_id: 
            - media_player.mass_kitchen_airplay_wiim_speaker
    attributes:
      is_volume_muted: media_player.wiim_kitchen_linkplay|is_volume_muted
      volume_level: media_player.wiim_kitchen_linkplay|volume_level
 

  ##########################  bathroom  ##########################
  - platform: universal
    name: Universal bathroom Speakers
    unique_id: universal_bathroom_speakers
    children:
      - media_player.bathroom_speaker
    active_child_template: >-    
                  media_player.mass_bathroom_speaker
    state_template: >-
                      {{ states('media_player.mass_bathroom_speaker') }}

 
    ##########################  lounge  ##########################
  - platform: universal
    name: Universal lounge Speakers
    unique_id: universal_lounge_speakers
    children:
      - media_player.mass_lounge_airplay_wiim_speaker
      - media_player.wiim_lounge_linkplay
      - media_player.group_mass_home_group_speakers
    active_child_template: >-
                  {% set mass_speaker = 'media_player.mass_lounge_airplay_wiim_speaker' %}
                  {% set linkplay_speaker = 'media_player.wiim_lounge_linkplay' %}
                  {% set mass_home_group = 'media_player.group_mass_home_group_speakers' %}
                  {% if states(linkplay_speaker) == 'idle' and states(mass_speaker) == 'idle' %}
                    {{ linkplay_speaker }}
                  {% else %}             
                    {{ mass_speaker }}
                  {% endif %}
    state_template: >-
                  {% set mass_speaker = 'media_player.mass_lounge_airplay_wiim_speaker' %}
                  {% set linkplay_speaker = 'media_player.wiim_lounge_linkplay' %}
                  {% set mass_home_group = 'media_player.group_mass_home_group_speakers' %}
                  {% if states(linkplay_speaker) == 'idle' and states(mass_speaker) == 'idle' %}
                  off
                  {% else %}             
                    {{ states(mass_speaker) }}
                  {% endif %}
    commands:
      volume_up:
        service: media_player.volume_up
        target:
          entity_id: 
            - media_player.wiim_lounge_linkplay
      volume_down:
        service: media_player.volume_down
        target:
          entity_id: 
            - media_player.wiim_lounge_linkplay
      volume_mute:
        service: media_player.volume_mute
        target:
          entity_id: 
            - media_player.wiim_lounge_linkplay
        data:
          is_volume_muted: "{{ is_volume_muted }}"
      volume_set:
        service: media_player.volume_set
        target:
          entity_id: 
            - media_player.wiim_lounge_linkplay
        data:
          volume_level: "{{ volume_level }}"
      turn_off:
        service: media_player.clear_playlist
        target:
          entity_id: 
            - media_player.mass_lounge_airplay_wiim_speaker
      turn_on:
        service: media_player.media_play
        target:
          entity_id: 
            - media_player.mass_lounge_airplay_wiim_speaker
    attributes:
      is_volume_muted: media_player.wiim_lounge_linkplay|is_volume_muted
      volume_level: media_player.wiim_lounge_linkplay|volume_level


    ##########################  hallway  ##########################
  - platform: universal
    name: Universal hallway Speakers
    unique_id: universal_hallway_speakers
    children:
      - media_player.mass_hallway_airplay_wiim_speaker
      - media_player.wiim_hallway_linkplay
      - media_player.group_mass_home_group_speakers
    active_child_template: >-
                  {% set mass_speaker = 'media_player.mass_hallway_airplay_wiim_speaker' %}
                  {% set linkplay_speaker = 'media_player.wiim_hallway_linkplay' %}
                  {% set mass_home_group = 'media_player.group_mass_home_group_speakers' %}
                  {% if states(linkplay_speaker) == 'idle' and states(mass_speaker) == 'idle' %}
                    {{ linkplay_speaker }}
                  {% else %}             
                    {{ mass_speaker }}
                  {% endif %}
    state_template: >-
                  {% set mass_speaker = 'media_player.mass_hallway_airplay_wiim_speaker' %}
                  {% set linkplay_speaker = 'media_player.wiim_hallway_linkplay' %}
                  {% set mass_home_group = 'media_player.group_mass_home_group_speakers' %}
                  {% if states(linkplay_speaker) == 'idle' and states(mass_speaker) == 'idle' %}
                  off
                  {% else %}             
                    {{ states(mass_speaker) }}
                  {% endif %}
    commands:
      volume_up:
        service: media_player.volume_up
        target:
          entity_id: 
            - media_player.wiim_hallway_linkplay
      volume_down:
        service: media_player.volume_down
        target:
          entity_id: 
            - media_player.wiim_hallway_linkplay
      volume_mute:
        service: media_player.volume_mute
        target:
          entity_id: 
            - media_player.wiim_hallway_linkplay
        data:
          is_volume_muted: "{{ is_volume_muted }}"
      volume_set:
        service: media_player.volume_set
        target:
          entity_id: 
            - media_player.wiim_hallway_linkplay
        data:
          volume_level: "{{ volume_level }}"
      turn_off:
        service: media_player.clear_playlist
        target:
          entity_id: 
            - media_player.mass_hallway_airplay_wiim_speaker
      turn_on:
        service: media_player.media_play
        target:
          entity_id: 
            - media_player.mass_hallway_airplay_wiim_speaker
    attributes:
      is_volume_muted: media_player.wiim_hallway_linkplay|is_volume_muted
      volume_level: media_player.wiim_hallway_linkplay|volume_level
 

   ##########################  salon  ##########################
  - platform: universal
    name: Universal salon Speakers
    unique_id: universal_salon_speakers
    children:
      - media_player.mass_salon_airplay_wiim_speaker
      - media_player.wiim_salon_linkplay
      - media_player.group_mass_home_group_speakers
    active_child_template: >-
                  {% set mass_speaker = 'media_player.mass_salon_airplay_wiim_speaker' %}
                  {% set linkplay_speaker = 'media_player.wiim_salon_linkplay' %}
                  {% set mass_home_group = 'media_player.group_mass_home_group_speakers' %}
                  {% if states(linkplay_speaker) == 'idle' and states(mass_speaker) == 'idle' %}
                    {{ linkplay_speaker }}
                  {% else %}             
                    {{ mass_speaker }}
                  {% endif %}
    state_template: >-
                  {% set mass_speaker = 'media_player.mass_salon_airplay_wiim_speaker' %}
                  {% set linkplay_speaker = 'media_player.wiim_salon_linkplay' %}
                  {% set mass_home_group = 'media_player.group_mass_home_group_speakers' %}
                  {% if states(linkplay_speaker) == 'idle' and states(mass_speaker) == 'idle' %}
                  off
                  {% else %}             
                    {{ states(mass_speaker) }}
                  {% endif %}
    commands:
      volume_up:
        service: media_player.volume_up
        target:
          entity_id: 
            - media_player.wiim_salon_linkplay
      volume_down:
        service: media_player.volume_down
        target:
          entity_id: 
            - media_player.wiim_salon_linkplay
      volume_mute:
        service: media_player.volume_mute
        target:
          entity_id: 
            - media_player.wiim_salon_linkplay
        data:
          is_volume_muted: "{{ is_volume_muted }}"
      volume_set:
        service: media_player.volume_set
        target:
          entity_id: 
            - media_player.wiim_salon_linkplay
        data:
          volume_level: "{{ volume_level }}"
      turn_off:
        service: media_player.clear_playlist
        target:
          entity_id: 
            - media_player.mass_salon_airplay_wiim_speaker
      turn_on:
        service: media_player.media_play
        target:
          entity_id: 
            - media_player.mass_salon_airplay_wiim_speaker
    attributes:
      is_volume_muted: media_player.wiim_salon_linkplay|is_volume_muted
      volume_level: media_player.wiim_salon_linkplay|volume_level
      
 

  ##########################  closet  ##########################
  - platform: universal
    name: Universal closet Speakers
    unique_id: universal_closet_speakers
    children:
      - media_player.mass_closet_airplay_wiim_speaker
      - media_player.wiim_closet_linkplay
      - media_player.group_mass_home_group_speakers
    active_child_template: >-
                  {% set mass_speaker = 'media_player.mass_closet_airplay_wiim_speaker' %}
                  {% set linkplay_speaker = 'media_player.wiim_closet_linkplay' %}
                  {% set mass_home_group = 'media_player.group_mass_home_group_speakers' %}
                  {% if states(linkplay_speaker) == 'idle' and states(mass_speaker) == 'idle' %}
                    {{ linkplay_speaker }}
                  {% else %}             
                    {{ mass_speaker }}
                  {% endif %}
    state_template: >-
                  {% set mass_speaker = 'media_player.mass_closet_airplay_wiim_speaker' %}
                  {% set linkplay_speaker = 'media_player.wiim_closet_linkplay' %}
                  {% set mass_home_group = 'media_player.group_mass_home_group_speakers' %}
                  {% if states(linkplay_speaker) == 'idle' and states(mass_speaker) == 'idle' %}
                  off
                  {% else %}             
                    {{ states(mass_speaker) }}
                  {% endif %}
    commands:
      volume_up:
        service: media_player.volume_up
        target:
          entity_id: 
            - media_player.wiim_closet_linkplay
      volume_down:
        service: media_player.volume_down
        target:
          entity_id: 
            - media_player.wiim_closet_linkplay
      volume_mute:
        service: media_player.volume_mute
        target:
          entity_id: 
            - media_player.wiim_closet_linkplay
        data:
          is_volume_muted: "{{ is_volume_muted }}"
      volume_set:
        service: media_player.volume_set
        target:
          entity_id: 
            - media_player.wiim_closet_linkplay
        data:
          volume_level: "{{ volume_level }}"
      turn_off:
        service: media_player.clear_playlist
        target:
          entity_id: 
            - media_player.mass_closet_airplay_wiim_speaker
      turn_on:
        service: media_player.media_play
        target:
          entity_id: 
            - media_player.mass_closet_airplay_wiim_speaker
    attributes:
      is_volume_muted: media_player.wiim_closet_linkplay|is_volume_muted
      volume_level: media_player.wiim_closet_linkplay|volume_level
      
 
  ##########################  CHROMECASTS  ##########################   
  

  ########################## Universal bedroom Chromecast  ########################## 
  
  
  - platform: universal
    unique_id: universal_bedroom_chromecast
    name: Universal bedroom chromecast
    children:
      - media_player.bedroom_chromecast
    active_child_template: >-
                  {% set ns = namespace( cast_entity = "media_player.bedroom_chromecast", template_entity = "" ) %}
                  {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                    
                  {% for media_player in states.media_player %}                   
                    {% if "plex" in media_player.entity_id and media_player.state != "unavailable" %}
                      {% set entity = media_player.entity_id %}
                      {% set media_title = state_attr( entity, 'media_title') %}
                      {% set media_series_title = state_attr( entity, 'media_series_title') %}
                      {% set media_series_episode = state_attr( entity, 'media_espisode') %}
                      {% set media_series_season = state_attr( entity, 'media_season') %}                      
                        {% if state_attr( ns.final_entity, 'media_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_title') in ( media_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}                    
                        {% elif state_attr( ns.final_entity, 'media_series_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_series_title') in ( media_series_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}
                        {% endif %}                      
                    {% endif %}                         
                  {% endfor %}                   
                  {% if ns.template_entity == "" %}
                      {% set ns.template_entity = ns.cast_entity %}
                  {% endif %}
                  {% if ns.template_entity != ns.cast_entity %}                  
                    {{ns.template_entity}}
                  {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                    media_player.bedroom_chromecast
                  {% else %}
                    media_player.bedroom_chromecast
                  {% endif %}          
    commands:
      volume_mute:
        service: media_player.volume_mute
        target:
          entity_id: 
            - media_player.bedroom_chromecast            
        data:
          is_volume_muted: "{{ is_volume_muted }}"
      volume_set:
        service: media_player.volume_set
        target:
          entity_id: 
            - media_player.bedroom_chromecast            
        data:
          volume_level: "{{ volume_level }}"
      volume_up:
        service: media_player.volume_up
        target:
          entity_id: 
            - media_player.bedroom_chromecast            
      volume_down:
        service: media_player.volume_down
        target:
          entity_id: 
            - media_player.bedroom_chromecast              
      media_pause:
        service: media_player.media_pause
        target:
          entity_id: 
            - media_player.bedroom_chromecast             
      media_play_pause:
        service: media_player.media_play_pause
        target:
          entity_id: 
            - media_player.bedroom_chromecast            
      turn_on:
        service: media_player.turn_on
        target:
          entity_id: 
            - media_player.bedroom_chromecast            
      turn_off:
        service: media_player.turn_off
        target:
          entity_id: 
            - media_player.bedroom_chromecast         
      media_stop:
        service: media_player.media_stop
        target:
          entity_id: 
            - media_player.bedroom_chromecast   
      media_play:
        service: media_player.media_play
        target:
          entity_id: 
            - media_player.bedroom_chromecast    
      play_media :
        service: media_player.play_media
        data:
          media_content_type: '{{media_content_type}}'
          media_content_id: '{{media_content_id}}'
        target:
          entity_id: 
            - media_player.bedroom_chromecast            
    attributes:
      is_volume_muted: media_player.bedroom_chromecast|is_volume_muted
      volume_level: media_player.bedroom_chromecast|volume_level
      state: media_player.bedroom_chromecast


  ########################## Universal salon Chromecast  ########################## 
  
  
  - platform: universal
    unique_id: universal_salon_chromecast
    name: Universal salon chromecast
    children:
      - media_player.salon_chromecast
    active_child_template: >-
                  {% set ns = namespace( cast_entity = "media_player.salon_chromecast", template_entity = "" ) %}
                  {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                    
                  {% for media_player in states.media_player %}                   
                    {% if "plex" in media_player.entity_id and media_player.state != "unavailable" %}
                      {% set entity = media_player.entity_id %}
                      {% set media_title = state_attr( entity, 'media_title') %}
                      {% set media_series_title = state_attr( entity, 'media_series_title') %}
                      {% set media_series_episode = state_attr( entity, 'media_espisode') %}
                      {% set media_series_season = state_attr( entity, 'media_season') %}                      
                        {% if state_attr( ns.final_entity, 'media_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_title') in ( media_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}                    
                        {% elif state_attr( ns.final_entity, 'media_series_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_series_title') in ( media_series_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}
                        {% endif %}                      
                    {% endif %}                         
                  {% endfor %}                   
                  {% if ns.template_entity == "" %}
                      {% set ns.template_entity = ns.cast_entity %}
                  {% endif %}
                  {% if ns.template_entity != ns.cast_entity %}                  
                    {{ns.template_entity}}
                  {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                    media_player.salon_chromecast
                  {% else %}
                    media_player.salon_chromecast
                  {% endif %}          
    commands:
      volume_mute:
        service: media_player.volume_mute
        target:
          entity_id: 
            - media_player.salon_chromecast            
        data:
          is_volume_muted: "{{ is_volume_muted }}"
      volume_set:
        service: media_player.volume_set
        target:
          entity_id: 
            - media_player.salon_chromecast            
        data:
          volume_level: "{{ volume_level }}"
      volume_up:
        service: media_player.volume_up
        target:
          entity_id: 
            - media_player.salon_chromecast            
      volume_down:
        service: media_player.volume_down
        target:
          entity_id: 
            - media_player.salon_chromecast              
      media_pause:
        service: media_player.media_pause
        target:
          entity_id: 
            - media_player.salon_chromecast             
      media_play_pause:
        service: media_player.media_play_pause
        target:
          entity_id: 
            - media_player.salon_chromecast            
      turn_on:
        service: media_player.turn_on
        target:
          entity_id: 
            - media_player.salon_chromecast            
      turn_off:
        service: media_player.turn_off
        target:
          entity_id: 
            - media_player.salon_chromecast         
      media_stop:
        service: media_player.media_stop
        target:
          entity_id: 
            - media_player.salon_chromecast   
      media_play:
        service: media_player.media_play
        target:
          entity_id: 
            - media_player.salon_chromecast    
      play_media :
        service: media_player.play_media
        data:
          media_content_type: '{{media_content_type}}'
          media_content_id: '{{media_content_id}}'
        target:
          entity_id: 
            - media_player.salon_chromecast            
    attributes:
      is_volume_muted: media_player.salon_chromecast|is_volume_muted
      volume_level: media_player.salon_chromecast|volume_level
      state: media_player.salon_chromecast

      
  ########################## Universal kitchen Chromecast  ########################## 


  - platform: universal
    unique_id: universal_kitchen_chromecast
    name: Universal kitchen chromecast
    children:
      - mmedia_player.kitchen_google_hub
    active_child_template: >-
                  {% set ns = namespace( cast_entity = "media_player.kitchen_google_hub", template_entity = "" ) %}
                  {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                    
                  {% for media_player in states.media_player %}                   
                    {% if "plex" in media_player.entity_id and media_player.state != "unavailable" %}
                      {% set entity = media_player.entity_id %}
                      {% set media_title = state_attr( entity, 'media_title') %}
                      {% set media_series_title = state_attr( entity, 'media_series_title') %}
                      {% set media_series_episode = state_attr( entity, 'media_espisode') %}
                      {% set media_series_season = state_attr( entity, 'media_season') %}                      
                        {% if state_attr( ns.final_entity, 'media_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_title') in ( media_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}                    
                        {% elif state_attr( ns.final_entity, 'media_series_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_series_title') in ( media_series_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}
                        {% endif %}                      
                    {% endif %}                         
                  {% endfor %}                   
                  {% if ns.template_entity == "" %}
                      {% set ns.template_entity = ns.cast_entity %}
                  {% endif %}
                  {% if ns.template_entity != ns.cast_entity %}                  
                    {{ns.template_entity}}
                  {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                    media_player.kitchen_google_hub
                  {% else %}
                    media_player.kitchen_google_hub
                  {% endif %}          
    commands:
      volume_mute:
        service: media_player.volume_mute
        target:
          entity_id: 
            - media_player.kitchen_google_hub            
        data:
          is_volume_muted: "{{ is_volume_muted }}"
      volume_set:
        service: media_player.volume_set
        target:
          entity_id: 
            - media_player.kitchen_google_hub            
        data:
          volume_level: "{{ volume_level }}"
      volume_up:
        service: media_player.volume_up
        target:
          entity_id: 
            - media_player.kitchen_google_hub            
      volume_down:
        service: media_player.volume_down
        target:
          entity_id: 
            - media_player.kitchen_google_hub              
      media_pause:
        service: media_player.media_pause
        target:
          entity_id: 
            - media_player.kitchen_google_hub             
      media_play_pause:
        service: media_player.media_play_pause
        target:
          entity_id: 
            - media_player.kitchen_google_hub            
      turn_on:
        service: media_player.turn_on
        target:
          entity_id: 
            - media_player.kitchen_google_hub            
      turn_off:
        service: media_player.turn_off
        target:
          entity_id: 
            - media_player.kitchen_google_hub         
      media_stop:
        service: media_player.media_stop
        target:
          entity_id: 
            - media_player.kitchen_google_hub     
      media_play:
        service: media_player.media_play
        target:
          entity_id: 
            - media_player.kitchen_google_hub          
      play_media :
        service: media_player.play_media
        data:
          media_content_type: '{{media_content_type}}'
          media_content_id: '{{media_content_id}}'
        target:
          entity_id: 
            - media_player.kitchen_google_hub       
    attributes:
      is_volume_muted: media_player.kitchen_google_hub|is_volume_muted
      volume_level: media_player.kitchen_google_hub|volume_level
      state: media_player.kitchen_google_hub

  ########################## Universal hotbox_top Chromecast  ########################## 


  - platform: universal
    unique_id: universal_hotbox_top_chromecast
    name: Universal hotbox top chromecast
    children:
      - media_player.hotbox_top_chromecast
    active_child_template: >-
                  {% set ns = namespace( cast_entity = "media_player.hotbox_top_chromecast", template_entity = "" ) %}
                  {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                    
                  {% for media_player in states.media_player %}                   
                    {% if "plex" in media_player.entity_id and media_player.state != "unavailable" %}
                      {% set entity = media_player.entity_id %}
                      {% set media_title = state_attr( entity, 'media_title') %}
                      {% set media_series_title = state_attr( entity, 'media_series_title') %}
                      {% set media_series_episode = state_attr( entity, 'media_espisode') %}
                      {% set media_series_season = state_attr( entity, 'media_season') %}                      
                        {% if state_attr( ns.final_entity, 'media_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_title') in ( media_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}                    
                        {% elif state_attr( ns.final_entity, 'media_series_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_series_title') in ( media_series_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}
                        {% endif %}                      
                    {% endif %}                         
                  {% endfor %}                   
                  {% if ns.template_entity == "" %}
                      {% set ns.template_entity = ns.cast_entity %}
                  {% endif %}
                  {% if ns.template_entity != ns.cast_entity %}                  
                    {{ns.template_entity}}
                  {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                    media_player.hotbox_top_chromecast
                  {% else %}
                    media_player.hotbox_top_chromecast
                  {% endif %}          
    commands:
      volume_mute:
        service: media_player.volume_mute
        target:
          entity_id: 
            - media_player.hotbox_top_chromecast            
        data:
          is_volume_muted: "{{ is_volume_muted }}"
      volume_set:
        service: media_player.volume_set
        target:
          entity_id: 
            - media_player.hotbox_top_chromecast            
        data:
          volume_level: "{{ volume_level }}"
      volume_up:
        service: media_player.volume_up
        target:
          entity_id: 
            - media_player.hotbox_top_chromecast            
      volume_down:
        service: media_player.volume_down
        target:
          entity_id: 
            - media_player.hotbox_top_chromecast              
      media_pause:
        service: media_player.media_pause
        target:
          entity_id: 
            - media_player.hotbox_top_chromecast             
      media_play_pause:
        service: media_player.media_play_pause
        target:
          entity_id: 
            - media_player.hotbox_top_chromecast            
      turn_on:
        service: media_player.turn_on
        target:
          entity_id: 
            - media_player.hotbox_top_chromecast            
      turn_off:
        service: media_player.turn_off
        target:
          entity_id: 
            - media_player.hotbox_top_chromecast         
      media_stop:
        service: media_player.media_stop
        target:
          entity_id: 
            - media_player.hotbox_top_chromecast   
      media_play:
        service: media_player.media_play
        target:
          entity_id: 
            - media_player.hotbox_top_chromecast            
      play_media :
        service: media_player.play_media
        data:
          media_content_type: '{{media_content_type}}'
          media_content_id: '{{media_content_id}}'
        target:
          entity_id: 
            - media_player.hotbox_top_chromecast            
    attributes:
      is_volume_muted: media_player.hotbox_top_chromecast|is_volume_muted
      volume_level: media_player.hotbox_top_chromecast|volume_level
      state: media_player.hotbox_top_chromecast

  ########################## Universal patio Chromecast  ########################## 


  - platform: universal
    unique_id: universal_patio_chromecast
    name: Universal patio chromecast
    children:
      - media_player.patio_chromecast
    active_child_template: >-
                  {% set ns = namespace( cast_entity = "media_player.patio_chromecast", template_entity = "" ) %}
                  {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                    
                  {% for media_player in states.media_player %}                   
                    {% if "plex" in media_player.entity_id and media_player.state != "unavailable" %}
                      {% set entity = media_player.entity_id %}
                      {% set media_title = state_attr( entity, 'media_title') %}
                      {% set media_series_title = state_attr( entity, 'media_series_title') %}
                      {% set media_series_episode = state_attr( entity, 'media_espisode') %}
                      {% set media_series_season = state_attr( entity, 'media_season') %}                      
                        {% if state_attr( ns.final_entity, 'media_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_title') in ( media_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}                    
                        {% elif state_attr( ns.final_entity, 'media_series_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_series_title') in ( media_series_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}
                        {% endif %}                      
                    {% endif %}                         
                  {% endfor %}                   
                  {% if ns.template_entity == "" %}
                      {% set ns.template_entity = ns.cast_entity %}
                  {% endif %}
                  {% if ns.template_entity != ns.cast_entity %}                  
                    {{ns.template_entity}}
                  {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                    media_player.patio_chromecast
                  {% else %}
                    media_player.patio_chromecast
                  {% endif %}          
    commands:
      volume_mute:
        service: media_player.volume_mute
        target:
          entity_id: 
            - media_player.patio_chromecast            
        data:
          is_volume_muted: "{{ is_volume_muted }}"
      volume_set:
        service: media_player.volume_set
        target:
          entity_id: 
            - media_player.patio_chromecast            
        data:
          volume_level: "{{ volume_level }}"
      volume_up:
        service: media_player.volume_up
        target:
          entity_id: 
            - media_player.patio_chromecast            
      volume_down:
        service: media_player.volume_down
        target:
          entity_id: 
            - media_player.patio_chromecast              
      media_pause:
        service: media_player.media_pause
        target:
          entity_id: 
            - media_player.patio_chromecast             
      media_play_pause:
        service: media_player.media_play_pause
        target:
          entity_id: 
            - media_player.patio_chromecast            
      turn_on:
        service: media_player.turn_on
        target:
          entity_id: 
            - media_player.patio_chromecast            
      turn_off:
        service: media_player.turn_off
        target:
          entity_id: 
            - media_player.patio_chromecast         
      media_stop:
        service: media_player.media_stop
        target:
          entity_id: 
            - media_player.patio_chromecast    
      media_play:
        service: media_player.media_play
        target:
          entity_id: 
            - media_player.patio_chromecast           
      play_media :
        service: media_player.play_media
        data:
          media_content_type: '{{media_content_type}}'
          media_content_id: '{{media_content_id}}'
        target:
          entity_id: 
            - media_player.patio_chromecast                 
    attributes:
      is_volume_muted: media_player.patio_chromecast|is_volume_muted
      volume_level: media_player.patio_chromecast|volume_level
      state: media_player.patio_chromecast

  ########################## Universal workshop Chromecast  ########################## 


  - platform: universal
    unique_id: universal_workshop_chromecast
    name: Universal workshop chromecast
    children:
      - media_player.workshop_chromecast
    active_child_template: >-
                  {% set ns = namespace( cast_entity = "media_player.workshop_chromecast", template_entity = "" ) %}
                  {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                    
                  {% for media_player in states.media_player %}                   
                    {% if "plex" in media_player.entity_id and media_player.state != "unavailable" %}
                      {% set entity = media_player.entity_id %}
                      {% set media_title = state_attr( entity, 'media_title') %}
                      {% set media_series_title = state_attr( entity, 'media_series_title') %}
                      {% set media_series_episode = state_attr( entity, 'media_espisode') %}
                      {% set media_series_season = state_attr( entity, 'media_season') %}                      
                        {% if state_attr( ns.final_entity, 'media_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_title') in ( media_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}                    
                        {% elif state_attr( ns.final_entity, 'media_series_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_series_title') in ( media_series_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}
                        {% endif %}                      
                    {% endif %}                         
                  {% endfor %}                   
                  {% if ns.template_entity == "" %}
                      {% set ns.template_entity = ns.cast_entity %}
                  {% endif %}
                  {% if ns.template_entity != ns.cast_entity %}                  
                    {{ns.template_entity}}
                  {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                    media_player.workshop_chromecast
                  {% else %}
                    media_player.workshop_chromecast
                  {% endif %}          
    commands:
      volume_mute:
        service: media_player.volume_mute
        target:
          entity_id: 
            - media_player.workshop_chromecast            
        data:
          is_volume_muted: "{{ is_volume_muted }}"
      volume_set:
        service: media_player.volume_set
        target:
          entity_id: 
            - media_player.workshop_chromecast            
        data:
          volume_level: "{{ volume_level }}"
      volume_up:
        service: media_player.volume_up
        target:
          entity_id: 
            - media_player.workshop_chromecast            
      volume_down:
        service: media_player.volume_down
        target:
          entity_id: 
            - media_player.workshop_chromecast              
      media_pause:
        service: media_player.media_pause
        target:
          entity_id: 
            - media_player.workshop_chromecast             
      media_play_pause:
        service: media_player.media_play_pause
        target:
          entity_id: 
            - media_player.workshop_chromecast            
      turn_on:
        service: media_player.turn_on
        target:
          entity_id: 
            - media_player.workshop_chromecast            
      turn_off:
        service: media_player.turn_off
        target:
          entity_id: 
            - media_player.workshop_chromecast         
      media_stop:
        service: media_player.media_stop
        target:
          entity_id: 
            - media_player.workshop_chromecast     
      media_play:
        service: media_player.media_play
        target:
          entity_id: 
            - media_player.workshop_chromecast            
      play_media :
        service: media_player.play_media
        data:
          media_content_type: '{{media_content_type}}'
          media_content_id: '{{media_content_id}}'
        target:
          entity_id: 
            - media_player.workshop_chromecast                    
    attributes:
      is_volume_muted: media_player.workshop_chromecast|is_volume_muted
      volume_level: media_player.workshop_chromecast|volume_level
      state: media_player.workshop_chromecast


  ##########################  following speaker ########################## 

  - platform: universal
    name: Universal following media
    unique_id: universal_following_media
    children:     
      - media_player.universal_home_speakers
      - media_player.universal_salon_speakers
      - media_player.universal_bedroom_speakers
      - media_player.universal_workshop_speakers
      - media_player.universal_kitchen_speakers
      - media_player.universal_bathroom_speakers
      - media_player.universal_lounge_speakers
      - media_player.universal_hallway_speakers
      - media_player.universal_hotbox_speakers
      - media_player.universal_bedroom_chromecast
      - media_player.universal_salon_chromecast
      - media_player.universal_hotbox_down_chromecast
      - media_player.universal_hotbox_top_chromecast
      - media_player.universal_patio_chromecast
      - media_player.universal_workshop_chromecast
    active_child_template: >-      
                  {% set location = states('sensor.maxi_location_by_petro') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "universal" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set state = media_player.state %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}                  
                  {% for entity in ns.entities %}  
                      {% set state = states( entity ) %}
                      {% if "chromecast" in entity and state != none and state_attr(entity,'is_volume_muted') == false %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                  {% endfor %}
                  {% if ns.final_entities | length == 0 %}
                  {% for entity in ns.entities %}
                      {% set state = states( entity ) %}
                      {% if "speaker" in entity and state != none  %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                  {% endfor %}
                  {% endif %}
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities.0 }}
                  {% else %}
                    media_player.group_mass_home_group_speakers
                  {% endif %}
    state_template: >-      
                  {% set location = states('sensor.maxi_location_by_petro') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "universal" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set state = media_player.state %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}                  
                  {% for entity in ns.entities %}  
                      {% set state = states( entity ) %}
                      {% if "chromecast" in entity and state != none and state_attr(entity,'is_volume_muted') == false %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                  {% endfor %}
                  {% if ns.final_entities | length == 0 %}
                  {% for entity in ns.entities %}
                      {% set state = states( entity ) %}
                      {% if "speaker" in entity and state != none  %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                  {% endfor %}
                  {% endif %}
                  {% if ns.final_entities | length > 0 %}
                  {{ states(ns.final_entities.0)}}
                  {% else %}
                    off
                  {% endif %}
    attributes:
      position: ENTITY_ID|ATTRIBUTE